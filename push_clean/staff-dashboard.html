<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard - KLHResolve</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: #2c3e50;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            border-left: 4px solid #28a745;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .complaint-table th {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        .action-buttons .btn {
            margin-right: 0.25rem;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        .status-dropdown {
            min-width: 140px;
        }
        .department-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .analytics-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .quick-stats {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: #2c3e50;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .stat-item {
            text-align: center;
            padding: 1rem;
        }
        .stat-item i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-university me-2"></i>
                KLHResolve - Staff Portal
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user-tie me-1"></i>
                    Welcome, <strong id="staffName">Staff Member</strong> 
                    <span class="department-badge badge bg-info ms-2" id="staffDepartmentBadge"></span>
                </span>
                <a class="nav-link" href="index.html" id="logoutBtn">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="container">
            <h1><i class="fas fa-tachometer-alt me-2"></i>Staff Dashboard</h1>
            <p class="lead" id="departmentGreeting">Manage and resolve student complaints</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="row">
                <div class="col-md-3">
                    <div class="stat-item">
                        <i class="fas fa-list-alt"></i>
                        <h3 id="totalComplaints">0</h3>
                        <p class="mb-0">Total Complaints</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-item">
                        <i class="fas fa-clock"></i>
                        <h3 id="pendingComplaints">0</h3>
                        <p class="mb-0">Pending Review</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-item">
                        <i class="fas fa-spinner"></i>
                        <h3 id="inProgressComplaints">0</h3>
                        <p class="mb-0">In Progress</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-item">
                        <i class="fas fa-check-circle"></i>
                        <h3 id="resolvedComplaints">0</h3>
                        <p class="mb-0">Resolved</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="analytics-card">
                    <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Complaints by Category</h5>
                    <div id="categoryChart">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-chart-pie fa-2x mb-2"></i>
                            <p>No data available for chart</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="analytics-card">
                    <h5 class="mb-3"><i class="fas fa-tachometer-alt me-2"></i>Performance Metrics</h5>
                    <div class="mb-3">
                        <small class="text-muted">Average Response Time</small>
                        <h4 id="avgResponseTime">2.3 hours</h4>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Resolution Rate</small>
                        <h4 id="resolutionRate">87%</h4>
                    </div>
                    <div>
                        <small class="text-muted">Student Satisfaction</small>
                        <h4 id="satisfactionRate">94%</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Complaints Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Department Complaints</h4>
                <div>
                    <select class="form-select form-select-sm me-2" id="statusFilter" style="width: auto; display: inline-block;">
                        <option value="all">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                    <select class="form-select form-select-sm" id="categoryFilter" style="width: auto; display: inline-block;">
                        <!-- Categories will be populated based on department -->
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div id="complaintsTable">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Complaint Modal -->
    <div class="modal fade" id="editComplaintModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Update Complaint Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editComplaintForm">
                        <input type="hidden" id="editComplaintId">
                        
                        <!-- Complaint Details -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Complaint Title</strong></label>
                            <p id="editComplaintTitle" class="form-control-plaintext"></p>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label"><strong>Student ID</strong></label>
                                <p id="editStudentInfo" class="form-control-plaintext"></p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><strong>Category</strong></label>
                                <p id="editComplaintCategory" class="form-control-plaintext"></p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label"><strong>Location</strong></label>
                                <p id="editComplaintLocation" class="form-control-plaintext"></p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><strong>Priority</strong></label>
                                <p id="editComplaintPriority" class="form-control-plaintext"></p>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>Description</strong></label>
                            <p id="editComplaintDescription" class="form-control-plaintext border p-2 rounded"></p>
                        </div>
                        
                        <!-- Status Update -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editStatus" class="form-label">Status</label>
                                <select class="form-select" id="editStatus" required>
                                    <option value="Pending">Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Resolved">Resolved</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editAssignedTo" class="form-label">Assign To</label>
                                <select class="form-select" id="editAssignedTo">
                                    <option value="">Not Assigned</option>
                                    <option value="Hostel Maintenance Team">Hostel Maintenance Team</option>
                                    <option value="IT Department">IT Department</option>
                                    <option value="Library Staff">Library Staff</option>
                                    <option value="Canteen Management">Canteen Management</option>
                                    <option value="Sports Department">Sports Department</option>
                                    <option value="Infrastructure Team">Infrastructure Team</option>
                                    <option value="Administration">Administration</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Staff Notes -->
                        <div class="mb-3">
                            <label for="editStaffNotes" class="form-label">Staff Notes (Internal)</label>
                            <textarea class="form-control" id="editStaffNotes" rows="3" placeholder="Add internal notes about this complaint..."></textarea>
                        </div>
                        
                        <!-- Resolution Details -->
                        <div class="mb-3">
                            <label for="editResolution" class="form-label">Resolution Details (Visible to Student)</label>
                            <textarea class="form-control" id="editResolution" rows="3" placeholder="Describe how the complaint was resolved..."></textarea>
                            <div class="form-text">This message will be visible to the student</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="saveComplaintChanges">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allComplaints = [];
        let editComplaintModal = null;
        let currentStaffDepartment = '';

        // Department to Category mapping
        const departmentCategories = {
            'hostel': ['Hostel Maintenance'],
            'academics': ['Academics'],
            'library': ['Library'],
            'infrastructure': ['Infrastructure', 'Sports Facilities', 'Canteen'],
            'administration': ['Administration', 'Other']
        };

        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
            if (!currentUser.identifier || currentUser.type !== 'staff') {
                window.location.href = 'index.html';
                return;
            }
            
            currentStaffDepartment = currentUser.department;
            document.getElementById('staffName').textContent = currentUser.identifier;
            document.getElementById('staffDepartmentBadge').textContent = getDepartmentDisplayName(currentStaffDepartment);
            document.getElementById('departmentGreeting').textContent = `Manage ${getDepartmentDisplayName(currentStaffDepartment)} complaints`;
            
            // Populate category filter with department-specific categories
            populateCategoryFilter();
            
            editComplaintModal = new bootstrap.Modal(document.getElementById('editComplaintModal'));
            loadDepartmentComplaints();
            setupEventListeners();
            setupLogout();
        });

        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            const categories = departmentCategories[currentStaffDepartment] || [];
            
            categoryFilter.innerHTML = '<option value="all">All Categories</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }

        function loadDepartmentComplaints() {
            const complaints = JSON.parse(localStorage.getItem('allComplaints') || '[]');
            allComplaints = complaints;
            
            // Filter complaints based on staff department
            const departmentComplaints = filterComplaintsByDepartment(complaints, currentStaffDepartment);
            
            displayComplaints(departmentComplaints);
            updateStatistics(departmentComplaints);
            updateAnalytics(departmentComplaints);
        }

        function filterComplaintsByDepartment(complaints, department) {
            const categories = departmentCategories[department] || [];
            return complaints.filter(complaint => categories.includes(complaint.category));
        }

        function displayComplaints(complaints) {
            const complaintsTable = document.getElementById('complaintsTable');
            
            if (complaints.length === 0) {
                complaintsTable.innerHTML = `
                    <div class="empty-state">
                        <div>ðŸ“‹</div>
                        <h4>No Complaints in Your Department</h4>
                        <p class="text-muted">No student complaints have been submitted for ${getDepartmentDisplayName(currentStaffDepartment)} yet.</p>
                    </div>
                `;
                return;
            }

            complaintsTable.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover complaint-table">
                        <thead>
                            <tr>
                                <th>Complaint ID</th>
                                <th>Student ID</th>
                                <th>Category</th>
                                <th>Title</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${complaints.map(complaint => `
                                <tr>
                                    <td><small>${complaint.id}</small></td>
                                    <td>${complaint.studentId}</td>
                                    <td>
                                        <span class="badge ${getCategoryBadgeClass(complaint.category)}">
                                            ${complaint.category}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="fw-bold">${complaint.title}</div>
                                        <small class="text-muted">${complaint.building} â€¢ ${complaint.floor}</small>
                                    </td>
                                    <td>${complaint.date}</td>
                                    <td>
                                        <span class="badge ${getStatusBadgeClass(complaint.status)}">
                                            ${complaint.status}
                                        </span>
                                        ${complaint.assignedTo ? `<br><small>${complaint.assignedTo}</small>` : ''}
                                    </td>
                                    <td><span class="badge ${getPriorityBadgeClass(complaint.priority)}">${complaint.priority.toUpperCase()}</span></td>
                                    <td class="action-buttons">
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewComplaint('${complaint.id}')">
                                            <i class="fas fa-eye me-1"></i>View
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="editComplaint('${complaint.id}')">
                                            <i class="fas fa-edit me-1"></i>Edit
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function updateStatistics(complaints) {
            document.getElementById('totalComplaints').textContent = complaints.length;
            document.getElementById('pendingComplaints').textContent = complaints.filter(c => c.status === 'Pending').length;
            document.getElementById('inProgressComplaints').textContent = complaints.filter(c => c.status === 'In Progress').length;
            document.getElementById('resolvedComplaints').textContent = complaints.filter(c => c.status === 'Resolved').length;
        }

        function updateAnalytics(complaints) {
            // Calculate performance metrics
            const totalComplaints = complaints.length;
            const resolvedComplaints = complaints.filter(c => c.status === 'Resolved').length;
            const resolutionRate = totalComplaints > 0 ? Math.round((resolvedComplaints / totalComplaints) * 100) : 0;
            
            document.getElementById('resolutionRate').textContent = `${resolutionRate}%`;
            
            // Update category chart
            updateCategoryChart(complaints);
        }

        function updateCategoryChart(complaints) {
            const categoryCounts = {};
            complaints.forEach(complaint => {
                categoryCounts[complaint.category] = (categoryCounts[complaint.category] || 0) + 1;
            });

            const chartHtml = Object.entries(categoryCounts).map(([category, count]) => `
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>${category}</span>
                        <span class="fw-bold">${count}</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${(count / complaints.length) * 100}%" 
                             aria-valuenow="${count}" aria-valuemin="0" aria-valuemax="${complaints.length}">
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('categoryChart').innerHTML = chartHtml || `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-chart-pie fa-2x mb-2"></i>
                    <p>No data available for chart</p>
                </div>
            `;
        }

        function setupEventListeners() {
            document.getElementById('statusFilter').addEventListener('change', function() {
                filterComplaints();
            });

            document.getElementById('categoryFilter').addEventListener('change', function() {
                filterComplaints();
            });

            document.getElementById('saveComplaintChanges').addEventListener('click', saveComplaintChanges);
        }

        function filterComplaints() {
            const statusFilter = document.getElementById('statusFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            let filteredComplaints = filterComplaintsByDepartment(allComplaints, currentStaffDepartment);
            
            if (statusFilter !== 'all') {
                filteredComplaints = filteredComplaints.filter(complaint => complaint.status === statusFilter);
            }
            
            if (categoryFilter !== 'all') {
                filteredComplaints = filteredComplaints.filter(complaint => complaint.category === categoryFilter);
            }
            
            displayComplaints(filteredComplaints);
            updateStatistics(filteredComplaints);
        }

        function viewComplaint(complaintId) {
            const complaint = allComplaints.find(c => c.id === complaintId);
            if (complaint) {
                alert(`Complaint Details:\n\nTitle: ${complaint.title}\nStudent ID: ${complaint.studentId}\nCategory: ${complaint.category}\nDescription: ${complaint.description}\nStatus: ${complaint.status}\nLocation: ${complaint.building} - ${complaint.floor}\nSpecific: ${complaint.specificLocation}`);
            }
        }

        function editComplaint(complaintId) {
            const complaint = allComplaints.find(c => c.id === complaintId);
            if (!complaint) return;

            document.getElementById('editComplaintId').value = complaint.id;
            document.getElementById('editComplaintTitle').textContent = complaint.title;
            document.getElementById('editStudentInfo').textContent = complaint.studentId;
            document.getElementById('editComplaintCategory').textContent = complaint.category;
            document.getElementById('editComplaintLocation').textContent = `${complaint.building} - ${complaint.floor} â€¢ ${complaint.specificLocation}`;
            document.getElementById('editComplaintPriority').textContent = complaint.priority;
            document.getElementById('editComplaintDescription').textContent = complaint.description;
            document.getElementById('editStatus').value = complaint.status;
            document.getElementById('editAssignedTo').value = complaint.assignedTo || '';
            document.getElementById('editStaffNotes').value = complaint.staffNotes || '';
            document.getElementById('editResolution').value = complaint.resolution || '';

            editComplaintModal.show();
        }

        function saveComplaintChanges() {
            const complaintId = document.getElementById('editComplaintId').value;
            const status = document.getElementById('editStatus').value;
            const assignedTo = document.getElementById('editAssignedTo').value;
            const staffNotes = document.getElementById('editStaffNotes').value;
            const resolution = document.getElementById('editResolution').value;

            const complaintIndex = allComplaints.findIndex(c => c.id === complaintId);
            if (complaintIndex !== -1) {
                allComplaints[complaintIndex].status = status;
                allComplaints[complaintIndex].assignedTo = assignedTo;
                allComplaints[complaintIndex].staffNotes = staffNotes;
                allComplaints[complaintIndex].resolution = resolution;
                
                allComplaints[complaintIndex].lastUpdated = new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                localStorage.setItem('allComplaints', JSON.stringify(allComplaints));
                
                // Also update in student-specific storage
                updateStudentComplaint(complaintId, {
                    status: status,
                    assignedTo: assignedTo,
                    resolution: resolution,
                    lastUpdated: allComplaints[complaintIndex].lastUpdated
                });

                loadDepartmentComplaints();
                editComplaintModal.hide();
                alert('Complaint updated successfully!');
            }
        }

        function updateStudentComplaint(complaintId, updates) {
            // Find which student this complaint belongs to
            const complaint = allComplaints.find(c => c.id === complaintId);
            if (complaint && complaint.studentId) {
                const studentComplaints = JSON.parse(localStorage.getItem(`complaints_${complaint.studentId}`) || '[]');
                const studentComplaintIndex = studentComplaints.findIndex(c => c.id === complaintId);
                
                if (studentComplaintIndex !== -1) {
                    Object.assign(studentComplaints[studentComplaintIndex], updates);
                    localStorage.setItem(`complaints_${complaint.studentId}`, JSON.stringify(studentComplaints));
                }
            }
        }

        function getDepartmentDisplayName(department) {
            const names = {
                'hostel': 'Hostel Management',
                'academics': 'Academics',
                'library': 'Library',
                'infrastructure': 'Infrastructure',
                'administration': 'Administration'
            };
            return names[department] || department;
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'Pending': 'bg-warning',
                'In Progress': 'bg-info',
                'Resolved': 'bg-success'
            };
            return classes[status] || 'bg-secondary';
        }

        function getPriorityBadgeClass(priority) {
            const classes = {
                'low': 'bg-secondary',
                'medium': 'bg-primary',
                'high': 'bg-warning',
                'urgent': 'bg-danger'
            };
            return classes[priority] || 'bg-secondary';
        }

        function getCategoryBadgeClass(category) {
            const classes = {
                'Hostel Maintenance': 'bg-primary',
                'Academics': 'bg-info',
                'Library': 'bg-success',
                'Canteen': 'bg-warning',
                'Sports Facilities': 'bg-danger',
                'Infrastructure': 'bg-secondary',
                'Administration': 'bg-dark',
                'Other': 'bg-light text-dark'
            };
            return classes[category] || 'bg-light text-dark';
        }

        function setupLogout() {
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    sessionStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                }
            });
        }
    </script>
</body>
</html>